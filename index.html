<!--
WebSlicer
Copyright (C) 2016  Marcio Teixeira
Copyright (C) 2020  SynDaver Labs, Inc.

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of the
License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
<!DOCTYPE html>
<html>
    <head>
        <meta charset=utf-8>
        <title>Web Slicer</title>
    </head>
    <body id="main">
        <script src="lib/three/three.min.js"></script>
        <script src="lib/three/OrbitControls.js"></script>
        <script src="lib/three/TransformControls.js"></script>
        <script src="lib/jquery/jquery.js"></script>
        <script src="lib/jquery/jquery.easing.1.3.js"></script>
        <script src="lib/FileSaver/FileSaver.js"></script>
        <script src="lib/geometry-lib/StlReader.js"></script>
        <script src="lib/geometry-lib/GeometrySerialize.js"></script>
        <script src="lib/three/ConvexHull.js"></script>
        <script src="lib/three/ConvexGeometry.js"></script>

        <!-- ***************** Prequisites for OutlinePass.js *****************
             We need all the following files to give selected objects a halo -->
        <script src="lib/three/Pass.js"></script>
        <script src="lib/three/RenderPass.js"></script>
        <script src="lib/three/ShaderPass.js"></script>
        <script src="lib/three/CopyShader.js"></script>
        <script src="lib/three/EffectComposer.js"></script>
        <script src="lib/three/OutlinePass.js"></script>
        <!-- ***************** Prequisites for OutlinePass.js ***************** -->

        <link rel="stylesheet" type="text/css" href="css/ui.css">
        <link rel="stylesheet" type="text/css" href="lib/ui/ui-theme.css">
        <link rel="stylesheet" type="text/css" href="lib/ui/settings/settings.css">
        <link rel="stylesheet" type="text/css" href="lib/ui/toolbar/toolbar.css">

        <script src="lib/ui/settings/settings.js"></script>
        <script src="lib/ui/toolbar/toolbar.js"></script>
        <script src="js/ui_printable_object.js"></script>
        <script src="js/ui_selection_group.js"></script>
        <script src="js/ui_render.js"></script>
        <script src="js/ui_stage.js"></script>
        <script src="js/ui.js"></script>

        <script src="lib/cura-engine/cura-interface.js"></script>

        <!-- Shader for drawing a checkered floor -->

        <script id="checkersVertexShader" type="x-shader/x-vertex">
            varying vec2 vUv;
 
            void main() {
                vUv = uv;
                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            }
        </script>

        <script id="checkersFragmentShader" type="x-shader/x-fragment">
            varying vec2  vUv;
            uniform float checkSize;
            uniform vec4  color1;
            uniform vec4  color2;

            vec4 checker(in float u, in float v) {
                float fmodResult = mod(floor(checkSize * u) + floor(checkSize * v), 2.0);

                if (fmodResult < 1.0) {
                    return color1;
                } else {
                    return color2;
                }
            }

            void main() {
                vec2 position = -1.0 + 2.0 * vUv;
                gl_FragColor = checker(vUv.x, vUv.y);
            }
        </script>

        <!-- Trick for colorizing images: https://css-tricks.com/color-filters-can-turn-your-gray-skies-blue/
             The target color is rgb(0.00 0.18 0.38) but for some reason we need to use (0.00, 0.03, 0.12) in
             the last column of the matrix to get that color. 
        -->
        <svg class="defs-only">
            <filter id="colorize-blue">
                <feColorMatrix type="matrix"
                    values="1.00 0 0 0 0.00
                            0.97 0 0 0 0.03
                            0.89 0 0 0 0.12
                            0    0 0 1 0"/>
            </filter>
        </svg>

        <canvas id="webgl">
            Sorry, your browser does not support the HTML canvas.
        </canvas>
        <div id="buttons">
            <button id="aboutbtn" onclick="showAbout()">About</button>
            <button id="fullscreen" onclick="enterFullscreen()">Fullscreen</button>
        </div>
        <div id="settings" class="panel dock-right dock-bottom"></div>
        <div id="toolbar"  class="panel dock-left  dock-bottom vertical"></div>

        <!-- Help table -->

        <table id="viewport-help">
            <tr>
                <th></th>
                <th>Mouse Button</th>
                <th>Keyboard</th>
            </tr>
            <tr>
                <th>Rotate</th>
                <td>Left</td>
                <td>A</td>
            </tr>
            <tr>
                <th>Zoom</th>
                <td>Middle</td>
                <td>S</td>
            </tr>
            <tr>
                <th>Pan</th>
                <td>Right</td>
                <td>D</td>
            </tr>
        </table>
        
        <div id="about" onclick="hideAbout()" class="dialog panel">
            <a href="www.syndaver.com"><img src="images/logo.png"></a>
            <h1>Simple Slicer V0.1</h1>
            <p>
                Simple Slicer is maintained by SynDaver Labs, Inc. for use with SynDaver printers. It uses the Cura Engine,
                which is developed by Ultimaker B.V. in cooperation with the community.
            </p>
            <p>
                Simple Slicer proudly uses the following open source projects:

                <table id="jslicense-labels1">
                    <tr>
                        <td>THREE.js</td>
                        <td><a target="_blank" href="lib/three/LICENSE">MIT</a></td>
                        <td><a target="_blank" href="https://github.com/mrdoob/three.js/">Source</a></td>
                    </tr>
                    <tr>
                        <td>FileSaver</td>
                        <td><a target="_blank" href="lib/FileSaver/LICENSE.md.txt">MIT</a></td>
                        <td><a target="_blank" href="https://github.com/eligrey/FileSaver.js/">Source</a></td>
                    </tr>
                    <tr>
                        <td>JavaScript Clipper</td>
                        <td><a target="_blank" href="http://www.boost.org/LICENSE_1_0.txt">Boost</a></td>
                        <td><a target="_blank" href="https://sourceforge.net/projects/jsclipper/">Source</a></td>
                    </tr>
                    <tr>
                        <td>CuraEngine</td>
                        <td><a target="_blank" href="src-cura/CuraEngine/LICENSE">AGPL</a></td>
                        <td><a target="_blank" href="https://github.com/Ultimaker/CuraEngine">Source</a></td>
                    </tr>
                    <tr>
                        <td>emscripten</td>
                        <td><a target="_blank" href="https://github.com/emscripten-core/emscripten/blob/master/LICENSE">MIT</a></td>
                        <td><a target="_blank" href="https://emscripten.org/">Source</a></td>
                    </tr>
                </table>
            </p>
            <p>
                This software is licensed under the <a href="COPYING">Affero GPL license</a>
                (<a target="_blank" href="https://github.com/SynDaverCO/web-cura">Source</a>).
            </p>
        </div>

        <script>
            var canvas       = document.getElementById("webgl");
            var stage        = new Stage();
            var renderEngine = new RenderEngine(canvas, stage);
            var toolbar      = new ToolbarUI("toolbar");

            //toolbar.addIcon("open-file",         "Open File",       "images/open-file.png",);
            toolbar.addIcon("move",              "Move Object",     "images/scale.png");
            toolbar.addIcon("scale",             "Scale Object",    "images/scale-max.png");
            toolbar.addIcon("rotate",            "Rotate Object",   "images/rotate.png");
            toolbar.addIcon("mirror",            "Mirror Object",   "images/mirror.png");
            //toolbar.addIcon("custom-supports", "Custom Supports", "images/custom-supports.png");
            //toolbar.addIcon("support-blocker", "Support Blocker", "images/support-blocker.png");
            toolbar.addIcon("layflat",           "Lay Flat",        "images/lay-flat.png");
            toolbar.addIcon("undo",              "Undo",            "images/undo.png");

            toolbar.onChange = function(id) {stage.onTranformToolChanged(id);};

            settingsInit("settings");

            slicer = new SlicerInterface();

            // Cura interface
            /*function clearLog() {
                document.getElementById('log').textContent = '';
            }

            function onConsoleMessage(str) {
                document.getElementById('log').textContent += str + '\n';
            }*/

            slicer.onFileReceived = function(data) {
                var blob = new Blob([data], {type: "application/octet-stream"});
                var fileName = "cura.gcode";
                saveAs(blob, fileName);
            }
        </script>
    </body>
</html>